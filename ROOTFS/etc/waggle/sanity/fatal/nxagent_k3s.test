#!/bin/bash
echo "NX-Agent K3S Node Test:"

# read the system manifest to see if this system is to have an NX-Agent
if cat  /etc/waggle/node-manifest.json | jq .nxagent.present | grep -q false; then
    echo "NX-Agent not installed in this node, assume pass"
    exit 0
fi

if timeout 30s kubectl get nodes --request-timeout='30s' | grep ws-nxagent | grep -q Ready; then
    echo "NX-Agent configured and ready as K3S agent"
    exit 0
fi

echo "Error: No NX-Agent configured as K3S agent"
exit 1
